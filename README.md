# M칩dulo de Seguimiento de Horas Semanales de Empleados

## Descripci칩n General

El m칩dulo de Seguimiento de Horas Semanales de Empleados es un complemento integral de Odoo dise침ado para monitorear autom치ticamente las horas de trabajo de los empleados, detectar discrepancias entre las horas esperadas y registradas, y notificar a los gerentes cuando sea necesaria una intervenci칩n. Este m칩dulo se integra perfectamente con los m칩dulos existentes de RRHH, Proyectos y Hojas de Tiempo de Odoo para proporcionar informaci칩n en tiempo real sobre la productividad y el cumplimiento de la fuerza laboral.

## Caracter칤sticas Principales

### 游늵 Seguimiento de Horas en Tiempo Real
- **Monitoreo de Semana Actual**: Calcula autom치ticamente las horas registradas por cada empleado para la semana actual
- **Actualizaciones Din치micas**: Las horas se recalculan en tiempo real cuando los empleados registran entradas de hoja de tiempo
- **Integraci칩n de Proyectos**: Solo cuenta las horas registradas contra proyectos reales (excluye tiempo administrativo)

### 游꿢 Detecci칩n de Discrepancias
- **Sistema de Estado Inteligente**: Categoriza a los empleados en cuatro niveles de estado:
  - **En Curso**: Dentro de 2 horas de las horas semanales esperadas
  - **Tiempo Extra**: 2-10 horas por encima de las horas esperadas
  - **Tiempo Insuficiente**: M치s de 2 horas por debajo de las horas esperadas
  - **Cr칤tico**: M치s de 10 horas por encima de las horas esperadas
- **Umbrales Configurables**: Las horas semanales esperadas pueden personalizarse por empleado
- **Configuraciones de Tolerancia**: Niveles de tolerancia incorporados previenen alertas innecesarias por variaciones menores

### 游닎 Notificaciones Autom치ticas a Gerentes
- **Alertas Inteligentes**: Notifica autom치ticamente a los gerentes cuando ocurren discrepancias significativas
- **L칩gica de Tiempo**: Env칤a alertas los jueves/viernes para problemas de la semana actual (permitiendo tiempo para correcci칩n)
- **Prevenci칩n de Duplicados**: Asegura que los gerentes no sean bombardeados con m칰ltiples alertas por el mismo problema
- **Plantillas de Email Enriquecidas**: Notificaciones de email profesionales con desgloses detallados de horas

### 游늳 Seguimiento Hist칩rico
- **Res칰menes Semanales**: Mantiene registros hist칩ricos completos de res칰menes de horas semanales
- **An치lisis de Tendencias**: Rastrea patrones en los h치bitos de trabajo de los empleados a lo largo del tiempo
- **Pista de Auditor칤a**: Registra cu치ndo se notific칩 a los gerentes y por qu칠 razones

## Componentes del M칩dulo

### Modelos

#### 1. Extensiones de Empleado RRHH (`hr_employee.py`)
Extiende el registro est치ndar de empleado con capacidades de seguimiento de horas semanales.

**Nuevos Campos:**
- `current_week_hours`: Campo calculado que muestra las horas totales de la semana actual
- `expected_weekly_hours`: Horas esperadas configurables (predeterminado: 40)
- `hours_discrepancy`: Diferencia entre horas registradas y esperadas
- `discrepancy_status`: Estado actual (en_curso, tiempo_extra, tiempo_insuficiente, cr칤tico)
- `weekly_summary_ids`: Relaci칩n uno-a-muchos con res칰menes hist칩ricos

**M칠todos Clave:**
- `_compute_weekly_hours()`: Calcula las horas de la semana actual desde las entradas de hoja de tiempo
- `_compute_hours_discrepancy()`: Determina la variaci칩n de las horas esperadas
- `_compute_discrepancy_status()`: Categoriza el estado del empleado basado en la discrepancia

#### 2. Extensiones de Hoja de Tiempo de Proyecto (`project_timesheet.py`)
Agrega disparadores autom치ticos al sistema de hoja de tiempo para monitoreo en tiempo real.

**Funcionalidad:**
- **Disparador de Creaci칩n**: Cuando se crean nuevas entradas de hoja de tiempo, verifica autom치ticamente las discrepancias
- **Disparador de Actualizaci칩n**: Cuando se modifican entradas existentes, recalcula los res칰menes de empleados afectados
- **Procesamiento Inteligente**: Solo activa verificaciones para empleados cuyos registros fueron realmente afectados

#### 3. Modelo de Resumen Semanal (`weekly_summary.py`)
Modelo central para gestionar res칰menes de horas semanales y notificaciones.

**Campos:**
- `employee_id`: Referencia al empleado
- `week_start_date` / `week_end_date`: Per칤odo de semana (lunes a domingo)
- `logged_hours`: Horas reales trabajadas durante la semana
- `expected_hours`: Horas esperadas para el empleado
- `discrepancy`: Diferencia calculada
- `status`: Estado calculado basado en la discrepancia
- `manager_notified`: Bandera que indica si se alert칩 al gerente
- `notification_date`: Marca de tiempo de la notificaci칩n
- `notes`: Campo de texto libre para comentarios adicionales

**M칠todos Clave:**
- `_generate_weekly_summaries()`: M칠todo programado para crear res칰menes de fin de semana
- `_check_weekly_discrepancies()`: Verificaci칩n de discrepancias en tiempo real para la semana actual
- `_notify_manager()`: Maneja la l칩gica de notificaci칩n al gerente y env칤o de emails

### Vistas e Interfaz de Usuario

#### 1. Vistas de Empleado Mejoradas
- **Barra de Estado**: Indicador visual de estado en la parte superior de los formularios de empleado
- **Pesta침a de Horas Semanales**: Secci칩n dedicada que muestra:
  - Estad칤sticas de la semana actual
  - Horas esperadas vs. reales
  - C치lculos de discrepancia
  - Res칰menes semanales hist칩ricos
- **Mejoras de Vista de Lista**: Resumen r치pido de estado en listas de empleados

#### 2. Gesti칩n de Resumen Semanal
- **Vistas Dedicadas**: Interfaz separada para revisar todos los res칰menes semanales
- **Opciones de Filtrado**: Filtrado f치cil por empleado, rango de fechas o estado
- **Seguimiento de Notificaciones**: Indicaci칩n clara de qu칠 res칰menes activaron alertas de gerente

#### 3. Indicadores Visuales de Estado
- **Insignias Codificadas por Color**: Verde (en curso), Amarillo (tiempo insuficiente), Naranja (tiempo extra), Rojo (cr칤tico)
- **Barras de Estado**: Indicadores estilo progreso que muestran el estado actual del empleado
- **Identificaci칩n R치pida**: Los gerentes pueden detectar problemas de un vistazo

### Seguridad y Control de Acceso

#### Niveles de Acceso:
- **Todos los Usuarios**: Acceso de lectura a res칰menes semanales
- **Usuarios de RRHH**: Acceso completo para crear y modificar res칰menes
- **Gerentes de RRHH**: Control administrativo completo incluyendo eliminaciones

#### Grupos de Seguridad:
- Integraci칩n con grupos de seguridad est치ndar de RRHH de Odoo
- Respeta las restricciones de acceso de empleados existentes
- Los gerentes solo ven los datos de sus reportes directos

### Automatizaci칩n y Programaci칩n

#### 1. Generaci칩n de Resumen Semanal
- **Acci칩n Programada**: Se ejecuta autom치ticamente cada lunes a las 9:00 AM
- **Procesamiento de Semana Anterior**: Genera res칰menes para la semana completada
- **Procesamiento en Lote**: Maneja todos los empleados activos en una sola ejecuci칩n
- **Prevenci칩n de Duplicados**: Omite empleados que ya tienen res칰menes para el per칤odo

#### 2. Monitoreo en Tiempo Real
- **Disparadores de Hoja de Tiempo**: Verificaciones autom치ticas cuando se crean/modifican hojas de tiempo
- **Alertas Basadas en Umbral**: Solo env칤a notificaciones para discrepancias significativas (>5 horas)
- **L칩gica de Tiempo**: Alertas de mitad de semana solo se env칤an jueves/viernes para permitir tiempo de correcci칩n

### Notificaciones por Email

#### Caracter칤sticas de Plantilla:
- **Formato Profesional**: Dise침o de email limpio y con marca
- **Informaci칩n Detallada**: Desglose completo de horas y discrepancias
- **Conciencia de Contexto**: Personalizado con nombres de gerente y empleado
- **Datos Accionables**: Indicaci칩n clara de qu칠 acci칩n puede ser necesaria

#### L칩gica de Notificaci칩n:
- **Jerarqu칤a de Gerente**: Usa las relaciones de gerente incorporadas de Odoo
- **Validaci칩n de Email**: Verifica direcciones de email v치lidas de gerente
- **Manejo de Errores**: Manejo elegante de gerentes faltantes o direcciones de email
- **Pista de Auditor칤a**: Registra todos los intentos de notificaci칩n y resultados

## Instalaci칩n y Configuraci칩n

### Prerrequisitos
- Odoo 17.0+
- M칩dulos requeridos: `hr`, `project`, `hr_timesheet`, `mail`

### Pasos de Instalaci칩n
1. Copiar el m칩dulo a su directorio de complementos de Odoo
2. Actualizar la lista de aplicaciones en Odoo
3. Instalar el m칩dulo "Seguimiento de Horas Semanales de Empleados"
4. Configurar las horas semanales esperadas para cada empleado
5. Configurar las relaciones de gerente en los registros de empleados

### Configuraci칩n Inicial
1. **Configuraci칩n de Empleado**: Establecer horas semanales esperadas para cada empleado (predeterminado: 40)
2. **Asignaci칩n de Gerente**: Asegurar que todos los empleados tengan gerentes asignados
3. **Configuraci칩n de Email**: Verificar que las direcciones de email de los gerentes sean correctas
4. **Integraci칩n de Hoja de Tiempo**: Asegurar que los empleados est칠n registrando tiempo en proyectos

## Gu칤a de Uso

### Para Administradores de RRHH
1. **Panel de Monitoreo**: Usar la vista de lista de empleados para identificar r치pidamente problemas de estado
2. **Revisar Res칰menes**: Acceder al men칰 de Resumen de Horas Semanales para an치lisis detallado
3. **Configurar Ajustes**: Ajustar las horas esperadas por empleado seg칰n sea necesario
4. **Auditar Notificaciones**: Rastrear qu칠 gerentes han sido notificados sobre problemas

### Para Gerentes
1. **Recibir Alertas**: Notificaciones autom치ticas por email para discrepancias de miembros del equipo
2. **Revisar Estado del Equipo**: Verificar formularios de empleados para el estado de la semana actual
3. **An치lisis Hist칩rico**: Revisar el historial de resumen semanal para patrones
4. **Tomar Acci칩n**: Hacer seguimiento con miembros del equipo basado en informaci칩n de alerta

### Para Empleados
1. **Visibilidad de Estado**: Ver el estado de la semana actual en el registro de empleado
2. **Seguimiento de Horas**: Ver horas registradas vs. esperadas en tiempo real
3. **Vista Hist칩rica**: Acceder al historial personal de resumen semanal
4. **Transparencia**: Comprensi칩n clara de las expectativas de horas y rendimiento

## Opciones de Personalizaci칩n

### Umbrales Configurables
- **Horas Esperadas**: Ajustables por empleado (soporta tiempo parcial, contratistas)
- **Niveles de Tolerancia**: Modificar la tolerancia de 2 horas en el c칩digo si es necesario
- **Umbrales Cr칤ticos**: Ajustar el nivel cr칤tico de 10 horas de tiempo extra
- **Tiempo de Alerta**: Cambiar el tiempo de alerta de jueves/viernes si se desea

### Plantillas de Email
- **Marca**: Personalizar plantillas de email con la marca de la empresa
- **Contenido**: Modificar el contenido y formato de notificaci칩n
- **Destinatarios**: Agregar destinatarios CC o modificar la l칩gica de notificaci칩n
- **Idiomas**: Soporte para plantillas de email multiidioma

### Categor칤as de Estado
- **Estados Personalizados**: Agregar categor칤as de estado adicionales si es necesario
- **Esquemas de Color**: Modificar indicadores visuales y codificaci칩n de colores
- **L칩gica de C치lculo**: Ajustar m칠todos de c치lculo de discrepancia
- **Per칤odos de Reporte**: Modificar definiciones de per칤odo semanal (actualmente lunes-domingo)

## Detalles T칠cnicos

### Estructura de Base de Datos
- **Nuevas Tablas**: `employee_weekly_summary`
- **Tablas Extendidas**: `hr_employee` (solo campos calculados)
- **Relaciones**: Mantiene integridad referencial con datos de RRHH existentes

### Consideraciones de Rendimiento
- **Campos Calculados**: Calculados eficientemente usando consultas de base de datos
- **Procesamiento en Lote**: Res칰menes semanales generados en lote
- **Indexaci칩n**: 칈ndices apropiados de base de datos en campos de fecha y empleado
- **Cach칠**: Aprovecha el cach칠 de campos incorporado de Odoo

### Puntos de Integraci칩n
- **Sistema de Hoja de Tiempo**: Integraci칩n perfecta con `account.analytic.line`
- **M칩dulo de RRHH**: Extiende la gesti칩n de empleados existente
- **M칩dulo de Proyecto**: Respeta el seguimiento de tiempo basado en proyectos
- **Sistema de Correo**: Usa la infraestructura de email de Odoo

## Soluci칩n de Problemas

### Problemas Comunes
1. **Notificaciones Faltantes**: Verificar asignaciones de gerente y direcciones de email
2. **Horas Incorrectas**: Verificar que las entradas de hoja de tiempo est칠n vinculadas a proyectos
3. **Estado No Se Actualiza**: Asegurar que las acciones programadas se est칠n ejecutando correctamente
4. **Problemas de Acceso**: Verificar asignaciones de grupos de seguridad

### Registro y Depuraci칩n
- **Registros del Sistema**: El m칩dulo registra actividades en el sistema de registro de Odoo
- **Manejo de Errores**: Manejo elegante de errores con mensajes informativos
- **Modo de Depuraci칩n**: Registro adicional disponible en modo de depuraci칩n

## Soporte y Mantenimiento

### Mantenimiento Regular
- **Revisiones Semanales**: Monitorear el proceso de generaci칩n de resumen semanal
- **Entregabilidad de Email**: Asegurar que los emails de notificaci칩n se est칠n entregando
- **Limpieza de Datos**: Limpieza peri칩dica de registros de resumen antiguos si es necesario
- **Monitoreo de Rendimiento**: Vigilar cualquier impacto en el rendimiento

### Consideraciones de Actualizaci칩n
- **Migraci칩n de Datos**: Los res칰menes se preservan durante las actualizaciones del m칩dulo
- **Respaldo de Configuraci칩n**: Exportar horas esperadas de empleados antes de actualizaciones importantes
- **Pruebas**: Probar la funcionalidad de notificaci칩n despu칠s de actualizaciones

## Historial de Versiones

### Versi칩n 1.0.0
- Lanzamiento inicial
- Seguimiento b치sico de horas semanales
- Sistema de notificaci칩n a gerentes
- Generaci칩n de resumen hist칩rico
- Categorizaci칩n de estado de empleados

---

## Licencia y Soporte

Este m칩dulo se proporciona tal como est치 para uso educativo y empresarial. Para soporte, solicitudes de personalizaci칩n o reportes de errores, por favor contacte a su administrador del sistema o desarrollador del m칩dulo.
